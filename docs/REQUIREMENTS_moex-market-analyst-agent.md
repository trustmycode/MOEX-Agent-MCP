# REQUIREMENTS — moex-market-analyst-agent

## 1. Источники требований

- ТЗ трека **MCP for Business AI Transformation**.
- Q&A с организаторами хакатона (устные/письменные разъяснения).
- Документация:
  - Cloud.ru **Evolution AI Agents**;
  - Cloud.ru **Evolution Foundation Models**;
  - MOEX **ISS API**.

---

## 2. Функциональные требования (FR)

### 2.1. Бизнес-функционал

**FR-1. Обзор инструмента**

Агент должен уметь по запросу пользователя выдать краткий обзор по тикеру:

- динамика цены за заданный период;
- изменения за последний день/неделю/месяц;
- базовые показатели ликвидности (объём, оборот).

**FR-2. Сравнение инструментов**

Агент должен уметь сравнивать несколько инструментов (минимум 2 тикера) по:

- доходности за период;
- волатильности;
- среднему обороту;
- (при наличии) доле в индексе.

**FR-3. Анализ индекса**

Агент должен уметь анализировать индекс (например, IMOEX):

- получить состав индекса;
- агрегировать показатели по бумагам;
- подсветить бумаги с повышенным вкладом в риск/волатильность.

**FR-4. Понятный отчёт**

Результат работы агента должен содержать:

- текстовое бизнес-резюме (на русском);
- табличные данные (для интеграции в UI/отчёты);
- (опционально в v1) краткий блок «Как интерпретировать эти метрики», сформированный на основе корпоративных методических материалов (см. FR-KB-MVP-1).

---

### 2.2. Взаимодействие с MCP

**FR-MCP-1. Использование MCP для данных**

Вся информация о рынке (цены, история, индексы) должна поступать в агент **только через MCP** (`moex-iss-mcp`), а не напрямую.

**FR-MCP-2. Бизнес-инструменты**

`moex-iss-mcp` обязан предоставлять минимум 3 бизнес-ориентированных инструмента:

1. `get_security_snapshot`
2. `get_ohlcv_timeseries`
3. `get_index_constituents_metrics`

**FR-MCP-3. Структурированный JSON-ответ**

Каждый tool возвращает JSON следующей структуры:

- `metadata` — служебная информация (тикер, даты, источник);
- `data` — массив записей или объект;
- `metrics` — агрегированные показатели.

### 2.3. Сценарии портфельного риска и ликвидности (`risk-analytics-mcp`)

**FR-RISK-1. Поддержка сценариев 5/7/9**

Агент должен уметь выполнять сценарии `issuer_peers_compare`, `portfolio_risk`, `cfo_liquidity_report`, опираясь на `ScenarioTemplate` и JSON-контракты из `SCENARIOS_PORTFOLIO_RISK.md`.

**FR-RISK-2. Согласованность со схемами**

Вызовы `risk-analytics-mcp` должны формироваться и проверяться по схемам: `PortfolioRiskInput/Report`, `RebalanceInput/Proposal`, `CfoLiquidityReportInput/Report`. Этот документ является SSOT для планировщика, валидации и авто-тестов.

**FR-RISK-3. Связь MCP слоёв**

`risk-analytics-mcp` получает рыночные данные только через `moex-iss-mcp` (а не напрямую в ISS), чтобы централизовать контроль над лимитами и ошибками.

---

### 2.4. Risk Dashboard и объяснения (AGI UI / RAG)

**FR-DASH-1. Risk DashboardSpec**

Агент должен уметь формировать структурированный JSON-дашборд риска (`RiskDashboardSpec`), который:

- включает ключевые численные показатели (доходность, волатильность, max drawdown, концентрации, Var_light и результаты стресс-сценариев);
- содержит описание виджетов (метрики, графики, таблицы, alerts) и ссылки на данные (data_ref), достаточные для отрисовки одного экрана «Risk Cockpit» во фронтенде / AGI UI;
- возвращается в составе A2A-ответа как `output.dashboard` и может использоваться как payload AGI UI backend‑события `type="risk_dashboard"`.

**FR-KB-MVP-1 (опционально, v1). Микро-RAG в базовых сценариях**

Для следующих сценариев уровня MVP:

- `single_security_overview` (FR-1),
- `compare_securities` (FR-2),
- `index_risk_scan` (FR-3),
- `portfolio_risk_basic` (сценарий 7 / `portfolio_risk` в базовой версии),
- (опционально) `portfolio_correlation_view` (drill-down по корреляциям),

агент **может** дополнительно:

- через `KnowledgeSubagent` → `kb-rag-mcp` получить краткие методические пояснения по использованным метрикам (доходность, волатильность, max drawdown, концентрации, Var_light);
- добавить в текстовый отчёт (output.text) небольшой блок «Как интерпретировать эти метрики» (1–3 абзаца).

Отсутствие RAG и/или `kb-rag-mcp` **не должно ломать** основной сценарий и не влияет на успешность MVP: в этом случае отчёт содержит численные результаты и текстовое резюме без методического блока.

**FR-KB-1 (v1.5). Сценарий `metric_explain`**

Агент должен поддерживать отдельный сценарий `metric_explain` (уровень v1.5), в котором:

- пользователь (обычно CFO/руководитель) задаёт вопрос вида «объясни, что означает Var_light 4.5% для этого портфеля» или «что такое волатильность/концентрация/HHI и что значит текущее значение»;
- `ExplainerSubagent` берёт числовой контекст (значение метрики, базовые параметры портфеля / сценария);
- `KnowledgeSubagent` через `kb-rag-mcp` получает методические описания и выдержки из регламентов;
- итоговый ответ структурирован так, чтобы:
  - описывать «что это за метрика»;
  - объяснять «как трактовать текущее значение для данного портфеля/тикера»;
  - по возможности ссылаться на внутренние методики/регламенты.

Без доступного RAG (`kb-rag-mcp`) сценарий `metric_explain` **считается недоступным**, т.к. теряет смысловую нагрузку.

**FR-KB-2 (v1.5). Сценарий `portfolio_news_explainer`**

Агент должен поддерживать сценарий `portfolio_news_explainer` (уровень v1.5), в котором:

- `RiskAnalyticsSubagent` пересчитывает метрики портфельного риска за заданный период (неделя/месяц) на основе `risk-analytics-mcp.compute_portfolio_risk_basic`;
- `KnowledgeSubagent` через `kb-rag-mcp` и/или подготовленный новостной корпус получает выдержки аналитики/новостей по top‑N бумагам портфеля;
- `ExplainerSubagent` формирует связанный ответ вида:
  - «что изменилось по цифрам» (доходность, волатильность, Var_light, концентрации);
  - «какие события (новости/события эмитента) могли повлиять на эти изменения».

Без RAG/новостного корпуса сценарий `portfolio_news_explainer` также считается недоступным.

**FR-KB-3 (v2). Сценарий `scheduled_digest`**

В перспективе v2 агент должен поддерживать сценарий регулярного дайджеста `scheduled_digest`, в котором:

- на основе результатов сценариев риска/портфеля за заданный период формируется периодический отчёт (например, раз в неделю/месяц);
- RAG‑слой используется для пояснения динамики метрик и ссылки на релевантные регламенты/аналитику.

**FR-KB-4 (v2). Сценарий `rebalance_proposals`**

В перспективе v2 агент должен поддерживать сценарий `rebalance_proposals`, в котором:

- `risk-analytics-mcp` формирует детерминированные предложения по ребалансировке портфеля (инструменты, целевые веса/сделки) на основе ограничений и целевых профилей;
- RAG‑слой обогащает эти предложения ссылками на:
  - внутренние лимиты и политику риск-менеджмента;
  - похожие кейсы из истории (прошлые отчёты, решения инвесткомитета).

RAG здесь не меняет сами предложения, а только объясняет и обосновывает их.

**Таблица 2.4.1. Сводка «сценарий ↔ RAG ↔ релиз»**

| Сценарий                   | Уровень релиза | Участие RAG                          | Обязателен для MVP |
| -------------------------- | -------------- | ------------------------------------ | ------------------ |
| single_security_overview   | v1 (MVP)       | Краткое объяснение метрик (опц.)     | Нет                |
| compare_securities         | v1 (MVP)       | Краткое объяснение метрик (опц.)     | Нет                |
| index_risk_scan            | v1 (MVP)       | Краткое объяснение метрик (опц.)     | Нет                |
| portfolio_risk_basic       | v1 (MVP)       | Краткое объяснение метрик (опц.)     | Нет                |
| portfolio_correlation_view | v1 (MVP)       | Краткое объяснение корреляций (опц.) | Нет                |
| metric_explain             | v1.5           | Основной сценарий (обязательно)      | Нет                |
| portfolio_news_explainer   | v1.5           | Основной сценарий (обязательно)      | Нет                |
| scheduled_digest           | v2+            | Объяснение динамики/новостей         | Нет                |
| rebalance_proposals        | v2+            | Обоснование ребалансировки           | Нет                |

## 3. Требования к MCP-серверу (подробно)

**FR-MCP-4. Стек MCP**

`moex-iss-mcp` реализован на базе **FastMCP** / `modelcontextprotocol`:

- использует транспорт `streamable-http`;
- предоставляет endpoint `/mcp`.

**FR-MCP-5. Схемы аргументов**

Для каждого tool:

- аргументы описаны Pydantic-моделью;
- для аргументов валидация (обязательность, диапазоны, форматы).

**FR-MCP-6. Обработка ошибок**

MCP должен:

- валидировать входные аргументы;
- обрабатывать сетевые ошибки и таймауты MOEX ISS;
- нормализовывать ошибки в структурированный ответ с полями:
  - `error_type`,
  - `message`,
  - `details`.

**FR-MCP-7. Безопасность**

- Все чувствительные данные (ключи, токены) передаются через env/Secret Manager.
- MCP не логирует секреты.

**FR-MCP-8. tools.json**

В репозитории должна быть зафиксирована спецификация MCP-инструментов:

- файл `tools.json` или эквивалент (`mcp_tools.json` в терминах корпоративного стандарта MCP);
- для каждого инструмента:
  - name,
  - description (EN),
  - input_schema (JSON Schema),
  - output_schema (JSON Schema).

**FR-MCP-9. Стандарт реализации MCP-серверов**

Все MCP-серверы решения (`moex-iss-mcp`, `risk-analytics-mcp`, опционально `kb-rag-mcp`) реализуются в соответствии со стандартом `docs/dependencies/Требования к MCP.docx.md`:

- существует единый экземпляр `FastMCP` в модуле `mcp_instance.py`, который импортируется в `server.py` и во все инструменты;
- каждый MCP-инструмент реализован как асинхронная функция `async def` в отдельном модуле `tools/*.py`, использует `Context` и `pydantic.Field` для описания аргументов и возвращает унифицированный `ToolResult`;
- конфигурация MCP читается только из переменных окружения с валидацией через общие утилиты (`_require_env_vars`, парсинг числовых значений); для разработчиков поддерживаются `.env.example` и, при необходимости, `env_options.json`;
- для каждого MCP-сервера ведётся JSON-описание инструментов (`<package>/tools.json`), выполняющее роль `mcp_tools.json` из стандарта, и файл `mcp-server-catalog.yaml` для регистрации сервера в каталоге Evolution AI Agents;
- ошибки протокольного уровня и ошибки валидации аргументов пробрасываются через `McpError`/`ErrorData` со стандартными кодами (-32600, -32601, -32602, -32603, -32700), а бизнес-ошибки нормализуются в структуру `error_type` / `message` / `details` в ответе MCP-инструментов;
- реализованы наблюдаемость и телеметрия: OpenTelemetry-спаны для основных операций, Prometheus-метрики (`tool_calls_total`, `tool_errors_total`, `mcp_http_latency_seconds`) и, при наличии LLM-операций в MCP, атрибуты OpenInference (`GEN_AI.*`).

**FR-RISK-MCP-1. Жёсткое соответствие схемам**

- Входы MCP-инструментов риска валидируются на уровне адаптера по JSON Schema/Pydantic до доменной логики.
- Выходные DTO маппятся 1-в-1 на схемы (имена полей, типы, обязательность), как описано в `ARCHITECTURE_LOW_LEVEL.md`.
- Контрактные тесты фиксируют схемы из `SCENARIOS_PORTFOLIO_RISK.md` и ломаются при любом несовпадении.

---

## 4. Требования к агенту

**FR-A-1. Стек агента**

Агент реализован на Python 3.12 с использованием:

- **ADK/A2A SDK** для интеграции с Evolution AI Agents;
- HTTP-клиента к Evolution Foundation Models.

**FR-A-2. Foundation Models**

Агент обязан:

- вызывать FM по API `https://foundation-models.api.cloud.ru/v1/`;
- использовать только модели Foundation Models в финальной версии;
- фиксировать выбор моделей и fallback-логику:
  - `LLM_MODEL_MAIN = Qwen3-235B` — основная модель в `ENVIRONMENT=prod`;
  - `LLM_MODEL_FALLBACK = gpt-oss-120b` — аварийный fallback при retryable-ошибках основного FM (timeout/сетевые/5xx/429);
  - `LLM_MODEL_DEV = GigaChat3-10B` — модель для `ENVIRONMENT=dev`;
  - правило выбора: при `ENVIRONMENT=prod` клиент сначала вызывает MAIN и при необходимости делает один повтор на FALLBACK; при `ENVIRONMENT=dev` всегда используется DEV;
  - префиксы моделей соответствуют каталогу Foundation Models (`hosted_vllm/...`), сторонние провайдеры в проде запрещены.

**FR-A-3. Взаимодействие с MCP**

Агент должен:

- вызывать MCP-инструменты на основе анализа входного запроса;
- передавать валидные аргументы (соответствующие JSON Schema/Pydantic);
- корректно обрабатывать ошибки MCP и транслировать их пользователю в человекочитаемом виде.

**FR-A-4. A2A-формат**

Агент должен соответствовать протоколу A2A:

- принимать входной JSON с полем `input.messages[]`;
- возвращать JSON с полем `output`:
  - `output.text` — человекочитаемый текстовый отчёт (на русском);
  - `output.tables[]` — табличные данные (при необходимости);
  - `output.dashboard` — структурированный JSON-дашборд риска (`RiskDashboardSpec`), используемый фронтендом/AGI UI как payload backend‑события `type="risk_dashboard"`;
  - `output.debug` (опционально) — отладочная информация (план, tool_calls, rag_sources и др.).

**FR-A-5. Agent Card**

Агент обязан публиковать **Agent Card** в соответствии со спецификацией A2A Evolution AI Agents:

- Agent Card содержит идентификатор агента (name, version), описание и домен задачи;
- описывает поддерживаемые протоколы (HTTP + JSON, A2A);
- указывает требования к аутентификации (использование сервисного аккаунта Evolution);
- перечисляет подключённые MCP-серверы (по URI из `MCP_URL`);
- содержит базовые ограничения по использованию (например, только данные Мосбиржи, read-only).

Наличие и корректность Agent Card является обязательным условием готовности решения к публикации в каталоге Evolution AI Agents.

**FR-A-6. Даты, глубина истории и индексы**

- При отсутствии явного периода в пользовательском запросе агент заполняет `to_date = today` (UTC) и `from_date = to_date - 365 дней` для всех вызовов tools с диапазонами дат.
- Глубина истории ограничена `MAX_LOOKBACK_DAYS = 730`; при превышении этого лимита агент или MCP возвращают нормализованную ошибку `DATE_RANGE_TOO_LARGE`.
- Для `index_ticker` агент использует справочник ISS (`IMOEX`, `RTSI` поддерживаются из коробки) и кэширует результат маппинга `index_ticker → indexid` 24 часа; при отсутствии маппинга возвращает `UNKNOWN_INDEX`.

**FR-VOICE-1 (v2+). Голосовой ввод**

В перспективе v2 пользователь должен иметь возможность задать запрос голосом через Web UI:

- аудио-запрос отправляется в компонент Voice Gateway;
- Voice Gateway вызывает ASR-модель (Whisper Large v3 / Foundation Models), получает текст;
- полученный текстовый запрос передаётся в `moex-market-analyst-agent` как стандартный A2A-вызов;
- по смыслу сценарии, доступные для голосового ввода, совпадают с текстовыми сценариями (в первую очередь `portfolio_risk`, `cfo_liquidity_report`, `issuer_peers_compare`).

**FR-VOICE-2 (v2+, опционально). Голосовой ответ**

По желанию заказчика, ответ агента может быть дополнительно преобразован в аудио (TTS) и воспроизведён пользователю, при этом текстовый `output.text` и `output.dashboard` остаются основным каналом для UI/AGI UI.

---

## 5. Платформенные требования (PR)

**PR-1. Платформа**

- Все компоненты (агент, MCP) деплоятся в **Cloud.ru Evolution AI Agents**.
- Образы собираются для `linux/amd64`.

**PR-2. Docker**

- Агент и MCP поставляются в виде Docker-образов:
  - без зависимости от локальной ФС в рантайме;
  - все зависимости устанавливаются при сборке.

**PR-3. Env / Secret Manager**

- Конфигурация агентов и MCP — через переменные окружения:
  - `AGENT_*`, `LLM_*`, `MCP_*`, `MOEX_*` и т.д.;
- Секреты — через Secret Manager / env, не в коде.

Дополнительно:

- для включения трассировки и метрик используются флаги `ENABLE_PHOENIX` и `ENABLE_MONITORING`;
- endpoint'ы телеметрии задаются через `PHOENIX_ENDPOINT` и `OTEL_ENDPOINT`;
- имена сервисов задаются через `PHOENIX_PROJECT_NAME` и `OTEL_SERVICE_NAME`.

**PR-4. Документация по запуску**

- README должен содержать:
  - шаги сборки Docker;
  - команды push в Registry;
  - шаги создания MCP и Agent в AI Agents;
  - пример демо-сценария и ожидаемый результат.

---

## 6. Нефункциональные требования (NFR)

### 6.1. Производительность

**NFR-1. MCP latency**

- 95-й перцентиль времени ответа MCP tools — не более 2–3 секунд (включая ISS).

**NFR-2. End-to-end latency**

- Полный цикл запроса агента (NL → ответ) для сценария «2 тикера, год истории» — не более 10–15 секунд.

### 6.2. Надёжность

**NFR-3. Устойчивость к ошибкам ISS**

- Ошибки ISS (timeout, 5xx, невалидный тикер) не приводят к падению MCP/агента.
- Пользователь должен получать понятное сообщение об ошибке.

**NFR-4. Rate limiting**

- MCP должен уважать лимит `MOEX_ISS_RATE_LIMIT_RPS`.
- При превышении — либо очередь, либо отказ с понятным сообщением.

### 6.3. Безопасность

**NFR-5. Хранение секретов**

- Все ключи, токены, пароли — только в Secret Manager/переменных окружения.
- Запрещено коммитить секреты в репозиторий.

### 6.4. Наблюдаемость

**NFR-6. Логирование**

- Логи должны фиксировать:
  - входные запросы (без персональных данных и секретов);
  - вызовы MCP и их длительность;
  - ошибки и stack trace (где уместно).

**NFR-7. Метрики**

- MCP и агент должны экспортировать метрики:
  - счётчики вызовов tools;
  - счётчики ошибок по типам;
  - гистограммы латентности.

### 6.5. Документация и тестирование

**NFR-8. Документация**

- Архитектура: `Архитектура moex-market-analyst-agent.md`.
- Требования: этот файл.
- SPEC MCP: `SPEC_moex-iss-mcp.md`.
- README: краткий overview + инструкция по запуску.

**NFR-9. Тесты**

- Минимум:
  - unit-тесты MCP (валидация аргументов, обработка ошибок, парсинг ISS);
  - smoke-тест агента (A2A end-to-end запрос с заглушками LLM/MCP).

**NFR-10. Контрактные проверки risk-analytics-mcp**

- Авто-тесты валидируют, что ответы `risk-analytics-mcp` соответствуют схемам из `SCENARIOS_PORTFOLIO_RISK.md`.
- Любое изменение схем сопровождается обновлением `ARCHITECTURE_*` и миграцией тестов.
