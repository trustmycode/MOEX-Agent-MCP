# REQUIREMENTS — moex-market-analyst-agent

## 1. Источники требований

- ТЗ трека **MCP for Business AI Transformation**.
- Q&A с организаторами хакатона (устные/письменные разъяснения).
- Документация:
  - Cloud.ru **Evolution AI Agents**;
  - Cloud.ru **Evolution Foundation Models**;
  - MOEX **ISS API**.

---

## 2. Функциональные требования (FR)

### 2.1. Бизнес-функционал

**FR-1. Обзор инструмента**

Агент должен уметь по запросу пользователя выдать краткий обзор по тикеру:

- динамика цены за заданный период;
- изменения за последний день/неделю/месяц;
- базовые показатели ликвидности (объём, оборот).

**FR-2. Сравнение инструментов**

Агент должен уметь сравнивать несколько инструментов (минимум 2 тикера) по:

- доходности за период;
- волатильности;
- среднему обороту;
- (при наличии) доле в индексе.

**FR-3. Анализ индекса**

Агент должен уметь анализировать индекс (например, IMOEX):

- получить состав индекса;
- агрегировать показатели по бумагам;
- подсветить бумаги с повышенным вкладом в риск/волатильность.

**FR-4. Понятный отчёт**

Результат работы агента должен содержать:

- текстовое бизнес-резюме (на русском);
- табличные данные (для интеграции в UI/отчёты).

---

### 2.2. Взаимодействие с MCP

**FR-MCP-1. Использование MCP для данных**

Вся информация о рынке (цены, история, индексы) должна поступать в агент **только через MCP** (`moex-iss-mcp`), а не напрямую.

**FR-MCP-2. Бизнес-инструменты**

`moex-iss-mcp` обязан предоставлять минимум 3 бизнес-ориентированных инструмента:

1. `get_security_snapshot`
2. `get_ohlcv_timeseries`
3. `get_index_constituents_metrics`

**FR-MCP-3. Структурированный JSON-ответ**

Каждый tool возвращает JSON следующей структуры:

- `metadata` — служебная информация (тикер, даты, источник);
- `data` — массив записей или объект;
- `metrics` — агрегированные показатели.

---

## 3. Требования к MCP-серверу (подробно)

**FR-MCP-4. Стек MCP**

`moex-iss-mcp` реализован на базе **FastMCP** / `modelcontextprotocol`:

- использует транспорт `streamable-http`;
- предоставляет endpoint `/mcp`.

**FR-MCP-5. Схемы аргументов**

Для каждого tool:

- аргументы описаны Pydantic-моделью;
- для аргументов валидация (обязательность, диапазоны, форматы).

**FR-MCP-6. Обработка ошибок**

MCP должен:

- валидировать входные аргументы;
- обрабатывать сетевые ошибки и таймауты MOEX ISS;
- нормализовывать ошибки в структурированный ответ с полями:
  - `error_type`,
  - `message`,
  - `details`.

**FR-MCP-7. Безопасность**

- Все чувствительные данные (ключи, токены) передаются через env/Secret Manager.
- MCP не логирует секреты.

**FR-MCP-8. tools.json**

В репозитории должна быть зафиксирована спецификация MCP-инструментов:

- файл `tools.json` или эквивалент;
- для каждого инструмента:
  - name,
  - description (EN),
  - input_schema (JSON Schema),
  - output_schema (JSON Schema).

---

## 4. Требования к агенту

**FR-A-1. Стек агента**

Агент реализован на Python 3.12 с использованием:

- **ADK/A2A SDK** для интеграции с Evolution AI Agents;
- HTTP-клиента к Evolution Foundation Models.

**FR-A-2. Foundation Models**

Агент обязан:

- вызывать FM по API `https://foundation-models.api.cloud.ru/v1/`;
- использовать только модели Foundation Models в финальной версии;
- задавать `LLM_MODEL` значением, начинающимся с префикса `hosted_vllm/`.

**FR-A-3. Взаимодействие с MCP**

Агент должен:

- вызывать MCP-инструменты на основе анализа входного запроса;
- передавать валидные аргументы (соответствующие JSON Schema/Pydantic);
- корректно обрабатывать ошибки MCP и транслировать их пользователю в человекочитаемом виде.

**FR-A-4. A2A-формат**

Агент должен соответствовать протоколу A2A:

- принимать входной JSON с полем `input.messages[]`;
- возвращать JSON с полем `output`:
  - `output.text`,
  - `output.tables[]`,
  - `output.debug` (опционально).

**FR-A-5. Agent Card**

Агент обязан публиковать **Agent Card** в соответствии со спецификацией A2A Evolution AI Agents:

- Agent Card содержит идентификатор агента (name, version), описание и домен задачи;
- описывает поддерживаемые протоколы (HTTP + JSON, A2A);
- указывает требования к аутентификации (использование сервисного аккаунта Evolution);
- перечисляет подключённые MCP-серверы (по URI из `MCP_URL`);
- содержит базовые ограничения по использованию (например, только данные Мосбиржи, read-only).

Наличие и корректность Agent Card является обязательным условием готовности решения к публикации в каталоге Evolution AI Agents.

---

## 5. Платформенные требования (PR)

**PR-1. Платформа**

- Все компоненты (агент, MCP) деплоятся в **Cloud.ru Evolution AI Agents**.
- Образы собираются для `linux/amd64`.

**PR-2. Docker**

- Агент и MCP поставляются в виде Docker-образов:
  - без зависимости от локальной ФС в рантайме;
  - все зависимости устанавливаются при сборке.

**PR-3. Env / Secret Manager**

- Конфигурация агентов и MCP — через переменные окружения:
  - `AGENT_*`, `LLM_*`, `MCP_*`, `MOEX_*` и т.д.;
- Секреты — через Secret Manager / env, не в коде.

Дополнительно:

- для включения трассировки и метрик используются флаги `ENABLE_PHOENIX` и `ENABLE_MONITORING`;
- endpoint'ы телеметрии задаются через `PHOENIX_ENDPOINT` и `OTEL_ENDPOINT`;
- имена сервисов задаются через `PHOENIX_PROJECT_NAME` и `OTEL_SERVICE_NAME`.

**PR-4. Документация по запуску**

- README должен содержать:
  - шаги сборки Docker;
  - команды push в Registry;
  - шаги создания MCP и Agent в AI Agents;
  - пример демо-сценария и ожидаемый результат.

---

## 6. Нефункциональные требования (NFR)

### 6.1. Производительность

**NFR-1. MCP latency**

- 95-й перцентиль времени ответа MCP tools — не более 2–3 секунд (включая ISS).

**NFR-2. End-to-end latency**

- Полный цикл запроса агента (NL → ответ) для сценария «2 тикера, год истории» — не более 10–15 секунд.

### 6.2. Надёжность

**NFR-3. Устойчивость к ошибкам ISS**

- Ошибки ISS (timeout, 5xx, невалидный тикер) не приводят к падению MCP/агента.
- Пользователь должен получать понятное сообщение об ошибке.

**NFR-4. Rate limiting**

- MCP должен уважать лимит `MOEX_ISS_RATE_LIMIT_RPS`.
- При превышении — либо очередь, либо отказ с понятным сообщением.

### 6.3. Безопасность

**NFR-5. Хранение секретов**

- Все ключи, токены, пароли — только в Secret Manager/переменных окружения.
- Запрещено коммитить секреты в репозиторий.

### 6.4. Наблюдаемость

**NFR-6. Логирование**

- Логи должны фиксировать:
  - входные запросы (без персональных данных и секретов);
  - вызовы MCP и их длительность;
  - ошибки и stack trace (где уместно).

**NFR-7. Метрики**

- MCP и агент должны экспортировать метрики:
  - счётчики вызовов tools;
  - счётчики ошибок по типам;
  - гистограммы латентности.

### 6.5. Документация и тестирование

**NFR-8. Документация**

- Архитектура: `Архитектура moex-market-analyst-agent.md`.
- Требования: этот файл.
- SPEC MCP: `SPEC_moex-iss-mcp.md`.
- README: краткий overview + инструкция по запуску.

**NFR-9. Тесты**

- Минимум:
  - unit-тесты MCP (валидация аргументов, обработка ошибок, парсинг ISS);
  - smoke-тест агента (A2A end-to-end запрос с заглушками LLM/MCP).
