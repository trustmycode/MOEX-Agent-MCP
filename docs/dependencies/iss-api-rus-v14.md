## Информационно-статистический сервер

# Программный интерфейс

# Информационно-статистического

# сервера Московской Биржи

# Руководство разработчика

# Версия 1. 4

## Содержание

- О сервере
- Отправка запросов
- Аутентификация
- Формат ответа от сервера
- Примечания к обработке данных
- Справочник запросов
- Принцип работы со справочником запросов

## О сервере

Информационно-статистический сервер Московской Биржи (ИСС / ISS) функционирует
в рамках программного комплекса Интернет-представительства биржи и служит для
предоставления клиентским приложениям данных с рынков Московской Биржи.

В рамках интерфейса доступны следующие типы информации: статические данные о
рынках (режимы торгов и их группы, финансовые инструменты и их описание), данные
для построения графиков («свечей»), сделки (анонимно), котировки, итоги торгов,
различные метаданные.

Данные о ходе торгов в режиме online и итоги торгов доступны только по подписке.

Индексы биржи всегда транслируются без задержки.

Взаимодействие с сервером осуществляется по протоколу http. Данные для
аутентификации возможно передавать по протоколу https.

## Отправка запросов

Запросы к ИСС формируются в виде URL с параметрами. Концепция формирования
ссылок базируется на архитектуре RESTful^1 , то есть параметры передаются не только в
конце строки, но и формируют сам URL.

Например, в запросе итогов торгов по инструментам режима:

[http://iss.moex.com/iss/history/engines/stock/markets/shares/boa](http://iss.moex.com/iss/history/engines/stock/markets/shares/boa)

rds/tqbr/securities.xml?date=2013- 12 - 20

Параметры, входящие в состав URL определяются синтаксисом каждого конкретного
запроса. На задаваемый параметром объект рынка указывает предшествующий этому
параметру элемент URL. Доступные типы рыночных объектов:

/engines/(trade_engine_name)

/markets/(market_name)

/boards/(boardid)

/boardgroups/(board_group_id)

/securities/{secid}

Значения первых четырёх переменных могут быть получены через запрос index,
последней – через securities.

Параметры в конце URL могут относиться или к конкретному блоку данных, который
будет получен через запрос, или ко всем блокам, или быть системными, применимыми
ко всем запросам.

Относящиеся к запросам параметры указаны в описании синтаксиса и могут
передаваться как с явным названием блока: «блок.параметр=», так и без:
«параметр=»; в последнем случае действие будет распространяться на все блоки, для
которых этот параметр имеет силу.

К системным параметрам относятся:

```
 iss.meta=on|off – включать или нет метаинформацию – перечень, тип
данных и размер полей (столбцов или атрибутов xml);
 iss.data=on|off – включать или нет непосредственно рыночные данные;
```

```
 iss.only=block1,block 2 – ответ может содержать несколько блоков
данных и этот параметр позволяет выбрать только нужные;
```

```
 <block>.columns=<id>,<id> – состав полей в ответе для конкретного
блока, например boards.columns=boardid,board_title Вместо указания
имени блока можно указывать словами его порядковый номер:
first.columns, second.columns и т.д.;
```

```
 iss.json=compact|extended – сокращенный или расширенный формат
json;
```

```
 iss.version=on|off – получать или нет (по умолчанию - нет) в заголовке
ответа сервера номер версии запроса (X-Micex-ISS-Query-Version) и номер
версии блока данных внутри ответа на запрос (X-Micex-ISS-Statement-Version).
```

(^1) см. [http://en.wikipedia.org/wiki/RESTful](http://en.wikipedia.org/wiki/RESTful)

Для запросов в формате CSV доступны следующие дополнительные параметры:

```
 iss.dp=comma|point – разделитель для десятичных знаков – запятая или
точка;
 iss.delimiter – разделитель полей, например iss.delimiter=;
```

 iss.df – формат даты;

 iss.tf – формат времени;

 iss.dtf – формат даты со временем;

Формат даты и/или времени задаётся в синтаксисе Unix-команды strptime, т.е.:

%a – сокращённое название дня недели;

%A – полное название дня недели;

%d – день месяца;

%D – дата в американском формате месяц/день/год;

%H – час;

%I – час в 12-часовом формате;

%j – номер дня от начала года;

%m – номер месяца;

%M – минуты;

%n – пробел;

%p – AM или PM;

%r – 12 - часовой формат времени с символами AM или PM;

%R – часы:минуты;

%S – секунды;

%T – часы:минуты:секунды;

%U – номер недели, неделя начинается с воскресенья; первое воскресенье января –
это первый день первой недели;

%w – номер дня недели; для воскресенья – 0;

%W – номер недели, неделя начинается с понедельника; первый понедельник января –
это первый день первой недели;

%x – дата в формате сервера;

%X – время в формате сервера;

%y – год в пределах века, значения 69- 99 относятся к XX веку, 00- 68 – к XXI (2000-
2068);

%Y – год, полностью.

Например: iss.df=%d-%m-%Y&iss.tf=%H:%M:%S

Поддерживается стандартный для веб-сервера Apache механизм компрессии.

## Аутентификация

Используется basic-аутентификация^2 , то есть имя пользователя и пароль передаются
серверу в заголовке запроса в соответствии со спецификацией.

Возможны следующие способы аутентификации:

1. По специальной ссылке по протоколу HTTPS:

https://passport.moex.com/authenticate

2. По любой ссылке на ресурсы (см. справочник запросов) по протоколу HTTP.
3. При подключении без аутентификации итоги торгов и ход торгов в режиме online
   недоступны.

При успешной аутентификации сервер возвращает cookie с именем MicexPassportCert,
хранящей сертификат аутентификации. Cookie должен быть сохранён до указанного в
нём времени жизни (expire) и отправляться при последующих запросах.

Следует обратить внимание, что ИСС-сервер не возвращает запроса на
аутентификацию (то есть http-статуса 401), поэтому некоторые работающие с basic-
аутентификацией библиотеки, ожидающие подобный запрос, могут и не передать
аутентификационные данные на сервер. Поэтому рекомендуется добавлять эти данные
в заголовок вручную.

При использовании сертификата проходить повторную basic-аутентификацию уже не
нужно. По истечении внутреннего времени жизни сертификата он заново формируется
сервером и отправляется пользователю с очередным ответом.

При получении данных, наличие в заголовке ответа значения «X-MicexPassport-Marker:
granted» будет свидетельствовать от том, что данные получены в соответствии с
правами доступа аутентифицированного пользователя.

Если же значение равно denied, то возможно два варианта: или ресурс полностью
закрыт из-за отсутствия подписки (Status 403), либо открыт, но полученные данные
являются задержанными (Status 200).

## Формат ответа от сервера

Формат, в котором необходимо получить данные, указывается в конце основной части
URL через точку.

Например:

[http://iss.moex.com/iss/history/engines/stock/markets/shares/boa](http://iss.moex.com/iss/history/engines/stock/markets/shares/boa)
rds/tqbr/securities.json?date=2013- 12 - 20

Поддерживаются следующие форматы: XML, CSV, JSON, HTML

Данные поступают от сервера как стандартный http-ответ с указанием в заголовке,
среди других стандартных параметров, Content-type (application/xml, text/csv, text/html,
text/plain для json) и кодировки (windows- 1251 для csv и UTF-8 для остальных).

Информационные блоки внутри ответа различаются по составу полей (столбцов) и
могут разделяться как по смыслу, так и по специфике содержащихся в нём данных.

Например, общий запрос о рынках

[http://iss.moex.com/iss/index.xml](http://iss.moex.com/iss/index.xml)

содержит блоки markets (рынки), boards (режимы торгов), board_groups (группировка
режимов), а запрос рыночных параметров инструментов

(^2) см. [http://en.wikipedia.org/wiki/Basic_access_authentication](http://en.wikipedia.org/wiki/Basic_access_authentication)

[http://iss.moex.com/iss/engines/stock/markets/index/securities.xml](http://iss.moex.com/iss/engines/stock/markets/index/securities.xml)

содержит блоки securities, marketdata, dataversion; первый остаётся неизменным в
течение всего торгового дня и может быть запрошен единожды, остальные изменяются
в динамике.

В ответах в форматах XML, HTML и JSON каждый блок содержит две секции:
метаданные и непосредственно рыночную информацию. Метаданные описывают тип и
длину полей с данными. Указываемая длина соответствует самой длинной строке в
ответе и выражена в байтах (число символов умноженное на 3).

## Примечания к обработке данных

 В ответах, содержащих различные параметры инструментов, присутствует атрибут
DECIMALS, указывающий на значимое для каждого конкретного инструмента число
знаков после запятой для цен.

 Если в описании поля присутствует непустой атрибут PRECISION, то все значения в
данном поле должны округляться до указанного числа знаков после запятой.
Используется математическое округление. Это значение перекрывает значение
атрибута DECIMALS.

 Служебное поле SEQNUM в некоторых таблицах содержит уникальный номер
обновления состояния таблицы. Его следует использовать в запросах для получения
информации не с самого начала, а только обновления со времени, когда было
получено предыдущее состояние таблицы.

 В ответах с инструментами, сделками и котировками присутствует блок dataversion.
Поле SEQNUM в этом блоке содержит стартовый номер состояния таблицы для
указанной версии. При увеличении значения версии поле SEQNUM изменяется, в
том числе оно может быть уменьшено. Следует отслеживать данный параметр для
корректной обработки переходов между торговыми днями, в случае если
подключающаяся к серверу система активна круглосуточно.

 Метаданные с описанием полей таблиц могут содержать следующие
вспомогательные атрибуты: is_signed – флаг, если значения в поле должны
выводиться со знаком; has_percent – флаг, если значения в поле должны
выводиться со знаком процента; alias – альтернативное название поля.

 Некоторые запросы содержат параметр start, который служит для указания номера
строки, с которой следует возвратить ответ. Присутствие этого параметра означает,
что сервер возвращает данные порциями определённого размера (например, по 100
строк). Соответственно, если необходимо получить все данные по запросу, следует
делать это в цикле, увеличивая каждый раз значение параметра start на полученное
в последнем ответе число строк до тех пор, пока не будет получен пустой блок
данных (т.е. только метаданные). Нумерация строк начинается с нуля и по
умолчанию start=0.

 ИСС-сервер работает в соответствии со стандартами протокола HTTP, поэтому в
случаях временных проблем возможно получение ответа со статусами 500-504. В
таком случае следует повторно запросить документ по тому же адресу через
небольшой промежуток времени.

 Структура ответов сервера в формате XML является динамической, поэтому при их
обработке следует обращаться к данным по их положению в иерархии,
идентификаторам (например, блок data с id=”securities”), имени (например,
тэг с описанием поля таблицы <column name="SECID">), комбинациям
ключевых атрибутов (например, BOARDID+SECID для идентификации инструмента
на режиме). Не следует рассматривать блоки, строки и т.п. как элементы с
фиксированным местом расположения относительно других элементов того же
уровня.

 В то время, как исторические данные по результатам торгов являются доступными
только по подписке, информация по индексам биржи доступна всем пользователем.
Поэтому разработчики, не имеющие подписки, но которым необходимо реализовать
ПО с доступом к историческим данным, могут использовать исторические данные по
индексам как образец.
Например:
[http://iss.moex.com/iss/history/engines/stock/markets/index/se](http://iss.moex.com/iss/history/engines/stock/markets/index/se)
curities.json?date=2010- 08 - 20

## Справочник запросов

Онлайн-справочник запросов доступен по адресу:

[http://iss.moex.com/iss/reference/](http://iss.moex.com/iss/reference/)

Префиксом к описанным в нём запросам является:

[http://iss.moex.com/](http://iss.moex.com/)

## Принцип работы со справочником запросов

Все приведенные в справочнике запросы принадлежат к одному из пространств имён. В
текущей версии их два:

```
 /iss – данные Торговой системы;
 /iss/history – данные итогов торгов.
```

Оба пространства имён содержат некоторое число одинаковых объектов, относящихся к
типам запрашиваемых данных. Некоторые объекты специфичны для одного из
пространств. Объекты, содержащие определенные данные, могут быть, в зависимости
от окончания строки запроса, следующими:

```
 /[security] – рыночные данные по инструменту (режиму, рынку);
 /trades – реестр сделок;
 /orderbook – котировки;
 /columns – описание полей в запросах;
 /candles – рассчитанные данные для построения графиков (свечек);
 /candleborders – интервалы, для которых есть данные по свечкам;
 /dates – даты, за которые есть итоги торгов;
```

```
 /turnovers – обороты;
 /zcyc – данные по кривой бескупонной доходности (zero-coupon yield curve);
 /listing – история торгуемости бумаги на различных режимах.
```

Также присутствуют (см. справочник) запросы для получения структуры рынков и для
поиска бумаг.

В зависимости от полномочий пользователя или результатов прохождения
аутентификации, в получении некоторых данных может быть отказано:

```
 в рамках именного пространства с данными итогов торгов вся информация, за
исключением индексов, доступна только авторизованным пользователям
(индексы доступны всем и всегда);
 в рамках именного пространства с данными Торговой системы всем
пользователям доступны данные о ходе торгов и структуре рынков (запросы с
```

```
префиксом /iss/engines), обороты (/turnovers), поиск инструментов,
спецификации бумаг, глобальные справочники и т.п.; по всем запросам
рыночных данных неавторизованным или неаутентифицированным
пользователям приходит информация с 15-минутной задержкой (где это
применимо), за исключением котировок (запросы с элементом /orderbook
внутри), которые доступны только авторизованным пользователям и индексов,
которые всегда доступны в режиме реального времени.
```

Как было отмечено выше, большинство запросов содержит в себе ряд параметров,
таких как engine, market, boardgroup, board, security. Значения параметров board и
security соответствуют реальным идентификаторам режимов торгов и инструментов в
торговых системах соответствующих рынков. Остальные параметры являются
группирующими на уровне ИСС.

Все перечисленные параметры могут (и в большинстве случаев использования –
должны) запрашиваться по нарастающей цепочке у ИСС с целью динамического
формирования запросов. Обычно подобная информация не меняется в течение
торговой сессии, поэтому имеет смысл формировать справочник рынков, режимов и
бумаг один раз в день.

Например, чтобы узнать итоговые значения фондового Индекса ММВБ за 23 - 24 августа
2010 года, логика для построения запроса может быть следующей:

1. Узнать идентификатор в ИСС для фондового рынка.

Запрос: [http://iss.moex.com/iss/engines.xml](http://iss.moex.com/iss/engines.xml)

```
Искомое значение: stock.
```

2. Узнать список рынков.

Запрос: [http://iss.moex.com/iss/engines/stock/markets.xml](http://iss.moex.com/iss/engines/stock/markets.xml)

```
Искомое значение: index.
```

3. Узнать режим торгов.

```
Запрос:
http://iss.moex.com/iss/engines/stock/markets/index/boards.xml
```

```
Искомое значение: SNDX.
```

При работе с фондовым рынком, когда инструменты могут переходить между
котировальными списками, при построении запроса итогов торгов целесообразно также
использовать запросы /listing для получения данных о том, на каких режимах в какие
периоды обращался инструмент.

Если необходимо получить и построить весь справочник рынков и режимов сразу,
можно использовать запрос: [http://iss.moex.com/iss.xml](http://iss.moex.com/iss.xml)

4. Найти требуемый инструмент.

```
Запрос: или через запрос рыночных данных по всему рынку:
http://iss.moex.com/iss/engines/stock/markets/index/boards/S
NDX/securities.xml
```

или поиском: [http://iss.moex.com/iss/securities.xml?q=MICEX](http://iss.moex.com/iss/securities.xml?q=MICEX)

```
Искомое значение: MICEXINDEXCF
```

5. Запросить, используя все полученные выше параметры, итоги торгов за
   интересующую дату.

```
http://iss.moex.com/iss/history/engines/stock/markets/index/
boards/SNDX/securities/MICEXINDEXCF.xml?from=2010- 08 -
23&till=2010- 08 - 24
```

Используя накопленные за перечисленные шаги данные, можно также сформировать,
например, следующие запросы:

 описание полей, возвращаемых вышеприведённым запросом:
[http://iss.moex.com/iss/engines/stock/markets/index/securities](http://iss.moex.com/iss/engines/stock/markets/index/securities)
/columns.xml

 перечень дат, за которые доступна история по инструменту:
[http://iss.moex.com/iss/history/engines/stock/markets/index/bo](http://iss.moex.com/iss/history/engines/stock/markets/index/bo)
ards/SNDX/securities/MICEXINDEXCF/dates.xml

 даты и интервалы, для которых доступны данные для графиков:
[http://iss.moex.com/iss/history/engines/stock/markets/index/bo](http://iss.moex.com/iss/history/engines/stock/markets/index/bo)
ards/SNDX/securities/MICEXINDEXCF/candleborders.xml

 данные для построения дневных графиков за период:
[http://iss.moex.com/iss/history/engines/stock/markets/index/bo](http://iss.moex.com/iss/history/engines/stock/markets/index/bo)
ards/SNDX/securities/MICEXINDEXCF/candles.xml?from=2010- 08 -
08&till=2010- 08 - 25&interval=24&start=

На страницах справочника, описывающих каждый конкретный запрос, приведен список
блоков данных, которые будут получены в ответ. Например, для запроса хода торгов
/iss/engines/[engine]/markets/[market]/securities это следующие блоки:

 securities – статические данные по бумагам;

 marketdata – динамическая информация с текущими рыночными параметрами
бумаг;

 dataversion – порядковый номер (sequence number) приведенного слепка данных.

Внутри описания каждого блока данных могут быть приведены параметры,
определяющие состав информации. Для последнего примера это:

 lang – язык ответа;

 securities – список-фильтр инструментов, по которым следует запросить данные;

 seqnum – номер последнего слепка данных, по сравнению с которым следует
прислать изменения.

Параметры могут передаваться как с указанием блока данных, к которому они
относятся, так и не указывая блок, тогда они будут учтены для всех блоков данных, к
которым параметр может быть применён.

Например, первый из следующих запросов вернет и статическую и динамическую
информацию только по указанным индексам, а второй – статическую информацию по
всем индексам, а текущие динамические параметры – только по указанным.

[http://iss.moex.com/iss/engines/stock/markets/index/securities.x](http://iss.moex.com/iss/engines/stock/markets/index/securities.x)

ml?securities=MICEX10INDEX,MICEXINDEXCF

[http://iss.moex.com/iss/engines/stock/markets/index/securities.x](http://iss.moex.com/iss/engines/stock/markets/index/securities.x)

ml?marketdata.securities=MICEX10INDEX,MICEXINDEXCF

Для некоторых запросов также доступен специальный блок данных "cursor",
указывающий текущую позицию отдаваемый данных относительно всего объёма
данных, доступных по этому запросу.

Например, по запросу
[http://iss.moex.com/iss/history/engines/stock/markets/shares/sec](http://iss.moex.com/iss/history/engines/stock/markets/shares/sec)

urities/MOEX
доступен блок "history.cursor", содержащий следующие поля:

```
 INDEX – начало текущего набора данных в выдаче (номер строки), в запросе
задаётся параметром start;
```

```
 TOTAL – общий объём данных (количество строк), доступных по этому запросу;
 PAGESIZE – объём текущего набора данных в выдаче (количество строк), в
запросе задаётся параметром limit (по умолчанию – 100, возможны значения 50,
20, 10, 5, 1).
```

Таким образом, чтобы выгрузить полный объём данных по вышеприведенному запросу,
нужно последовательно производить выгрузку, увеличивая значение параметра start на
каждом шаге на значение pagesize:

[http://iss.moex.com/iss/history/engines/stock/markets/shares/securities/MOEX](http://iss.moex.com/iss/history/engines/stock/markets/shares/securities/MOEX)

```
http://iss.moex.com/iss/history/engines/stock/markets/shares/securities/MOEX?start=
http://iss.moex.com/iss/history/engines/stock/markets/shares/securities/MOEX?start=
... И далее, до тех пор, пока (INDEX + PAGESIZE) < TOTAL.
```
