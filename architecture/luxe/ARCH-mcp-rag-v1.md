---
id: ARCH-mcp-rag
title: "MCP-сервер kb-rag-mcp (люксовый RAG-слой)"
type: service
layer: knowledge
owner: @team-moex-agent
version: v1
status: draft
created: 2025-12-10
updated: 2025-12-10
tags: [mcp, rag, kb, luxe]
depends_on: []
referenced_by: [ARCH-agent-moex-market-analyst]
---

## Контекст

`kb-rag-mcp` — опциональный MCP‑сервер для сценариев «объясни/расскажи»,
который дополняет числовые отчёты агента текстовым контекстом:

- выдержки из методических документов МОEX/ЦБ по волатильности, индексам,
  риск‑менеджменту;
- внутренние регламенты по лимитам, ковенантам и процедурам;
- шаблоны отчётов инвесткомитетов и финкомитетов.

RAG‑слой **не влияет на численные расчёты** сценариев 5/7/9, а только помогает
агенту более убедительно объяснять метрики, выводы и рекомендации.

## Структура

```text
kb_rag_mcp/
  __init__.py
  main.py                 # Точка входа FastMCP (transport="streamable-http")
  config.py               # Путь к корпусу, параметры индекса, телеметрия
  server.py               # Инициализация FastMCP, регистрация tools

  index/
    builder.py            # Построение/обновление векторного индекса
    store.py              # Обёртка над FAISS / аналогом

  corpus/
    # Набор документов (PDF/Markdown/HTML), подготовленных оффлайн

  tools/
    __init__.py
    rag_search.py         # Основной tool rag_search(query, top_k)

  telemetry/
    __init__.py
    metrics.py
    tracing.py
```

Основной публичный инструмент MCP:

- `rag_search(query: str, top_k: int = 5)` → список фрагментов
  `{title, snippet, source}`.

## Поведение и интеграция с агентом

- A2A‑агент вызывает `rag_search` в двух случаях:
  - когда пользователь явно просит объяснить термин/метрику;
  - когда планировщик видит, что числовой отчёт нуждается в методическом
    контексте (например, объяснение Var_light, дюрации, stress‑сценария).
- Ответ RAG MCP **никогда** не подмешивается в числовые поля отчётов, лишь в
  текстовое `output.text` (с явным указанием источника).

## Наблюдаемость и ограничения

- Метрики: число вызовов `rag_search`, средний размер ответа, латентность.
- RAG‑корпус формируется только из документов, на которые у заказчика есть
  права; внешние публичные источники (новости/research) подключаются только
  после отдельной юридической оценки.

## Эволюция

- Добавление специализированных tools (например, `explain_metric`,
  `explain_scenario`) с жёстко заданными промптами и фильтрами по корпусу.
- Вынесение RAG‑корпуса под управляемый сервис (например,
  evolution-managed-rag-mcp) с сохранением того же контракта `rag_search`.


