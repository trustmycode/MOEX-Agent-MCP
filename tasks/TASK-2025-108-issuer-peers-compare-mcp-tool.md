# TASK-2025-108: MCP-tool issuer_peers_compare (fundamentals & peers)

## Статус

- Статус: done
- Приоритет: P0
- Компонент: risk-analytics-mcp
- Связанные сценарии: issuer_peers_compare (5), portfolio_risk (7) — частично

## Контекст

Сценарий 5 требует сравнительного анализа эмитента с пирами по
фундаментальным показателям и мультипликаторам. В архитектуре предусмотрен
`FundamentalsDataProvider` (TASK-2025-102) и отдельный MCP-сервер
`risk-analytics-mcp`, но отсутствует конкретный инструмент, который бы:

- принимал идентификатор эмитента и настройки выборки пиров;
- агрегировал данные фундаментала и рынка в унифицированную таблицу;
- возвращал структурированный JSON, удобный для агента и A2A-интерфейса.

Без такого инструмента сценарий 5 (`issuer_peers_compare`) оказывается
распылённым между агентом и несколькими MCP-вызовами, что ухудшает
тестируемость и объяснимость.

## Цель

Реализовать MCP-инструмент `issuer_peers_compare` в `risk-analytics-mcp`,
который по одному эмитенту и заданным правилам отбора формирует компактный,
детерминированный peers-отчёт по ключевым финансовым и рыночным метрикам.

## Объём работ

### In scope

- Определение Pydantic-моделей входа/выхода инструмента `issuer_peers_compare`:
  - **Вход** (черновой состав):
    - идентификатор эмитента: `ticker` / `isin` / `issuer_id` (как минимум один);
    - опциональные фильтры: сектор/отрасль, индекс (например, IMOEX), лимит `max_peers`;
    - параметры периода для расчёта динамических метрик (при необходимости).
  - **Выход** (high-level):
    - `base_issuer` — агрегированные метрики по целевому эмитенту;
    - `peers[]` — массив пиров с тем же набором показателей;
    - `ranking`/`percentiles` по ключевым метрикам (P/E, EV/EBITDA, ROE, NetDebt/EBITDA, дивидендная доходность);
    - `error` — нормализованный блок ошибок.

- Реализация бизнес-логики инструмента в `risk-analytics-mcp`:
  - получение сырого фундаментала через `FundamentalsDataProvider` (TASK-2025-102);
  - выбор списка пиров по заданным правилам (сектор/индекс/внутренний список);
  - расчёт мультипликаторов и относительных позиций эмитента среди пиров;
  - простая эвристика флагов (`overvalued/undervalued`, `high_leverage`, `low_margin` и т.п.).

- Обработка ошибок и краевых случаев:
  - несуществующий тикер / отсутствие фундаментальных данных (`INVALID_TICKER`, `NO_FUNDAMENTAL_DATA`);
  - отсутствие подходящих пиров (`NO_PEERS_FOUND`);
  - недостаточная глубина истории/отчётности.

- Юнит-тесты с использованием snapshot-данных:
  - минимум 2–3 зафиксированных примера (SBER + peers, эмитент с малым числом пиров);
  - проверка устойчивости выходных структур и отсутствие NaN/inf.

### Out of scope

- Сложная нормализация отчётности (МСФО vs РСБУ) и приведение к единой валюте для всех возможных эмитентов — в MVP допускаются разумные допущения.
- Поддержка нескольких альтернативных поставщиков фундаментальных данных одновременно — достаточно MOEX ISS через `FundamentalsDataProvider`.
- RAG-пояснения по отчётности и событиям эмитента (это задача RAG-интерфейсов и последующих фаз).

## Acceptance Criteria

- [x] В `risk-analytics-mcp` реализован tool `issuer_peers_compare` с Pydantic-схемами входа/выхода, согласованными с `SCENARIOS_PORTFOLIO_RISK.md` (раздел сценария 5) и общими принципами SPEC.
- [x] Инструмент использует `FundamentalsDataProvider` (TASK-2025-102) как единственный источник фундаментальных данных и не обращается к ISS напрямую.
- [x] При типовом запросе (крупный эмитент Мосбиржи, например SBER) ответ содержит базовый эмитент, не менее N пиров (по настройке `max_peers`) и корректное ранжирование по выбранным мультипликаторам.
- [x] Все ошибки маппятся в нормализованный `error_type` (`INVALID_TICKER`, `NO_PEERS_FOUND`, `NO_FUNDAMENTAL_DATA`, `UNKNOWN`) и сопровождаются человекочитаемым сообщением для агента.
- [x] Написано минимум 2–3 юнит-теста на основе сохранённых JSON-ответов MOEX ISS и/или зафиксированных доменных примеров.

## Зависимости и связи

- Зависит от:
  - TASK-2025-102 — реализация `FundamentalsDataProvider` и `MoexIssFundamentalsProvider`.
  - TASK-2025-076/077/079 — наличие каркаса `risk-analytics-mcp` и SPEC.
- Поддерживает:
  - TASK-2025-104 — планировщик P0 по сценарию 5 (`issuer_peers_compare`).
  - TASK-2025-107 — демонстрационный сценарий для аналитика по рынку РФ.
