---
id: TASK-2025-065
title: "Фаза PC.4. Интеграция ToolRegistry в сценарии"
status: backlog
priority: medium
type: feature
estimate: 8h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-049]
arch_refs: [ARCH-agent-moex-market-analyst, ARCH-mcp-moex-iss]
risk: low
benefit: "Позволяет ScenarioTemplate учитывать доступность MCP-инструментов и адекватно деградировать при их отключении."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Интегрировать `ToolRegistry` в ScenarioTemplates так, чтобы сценарии не хардкодили сведения о доступности MCP-инструментов и могли корректно реагировать на их отключение (полная недоступность сценария или упрощённая деградированная версия).

## Критерии приемки

- ScenarioTemplates при построении плана используют `ToolRegistry` для проверки доступности необходимых инструментов (`enabled=true`).
- При отключении критичного инструмента (например, `get_index_constituents_metrics` для `index_risk_scan`) сценарий:
  - либо помечается как недоступный с явным сообщением в debug-выводе;
  - либо переключается на упрощённую версию (если такая предусмотрена), также фиксируя деградацию в логах.
- Для отключения портфельных инструментов предусмотрено предсказуемое поведение сценариев `portfolio_risk`/`portfolio_risk_drill_down` (например, отказ от детального анализа с внятным сообщением).

## Определение готовности

- В тестах отключение конкретного MCP-инструмента через `ToolRegistry` приводит к ожидаемому изменению поведения соответствующих сценариев без скрытых ошибок и падений.
- Логи и debug-вывод содержат информацию о том, какие сценарии и почему были деградированы или отключены.

## Заметки

Эта подзадача опирается на реализацию `ToolRegistry` (PA.2) и формальные ScenarioTemplates (PC.2–PC.3).
