---
id: TASK-2025-051
title: "Фаза PE. Production-grade-функции планировщика"
status: backlog
priority: low
type: feature
estimate: 32h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-003, TASK-2025-007, TASK-2025-008]
arch_refs: [ARCH-agent-moex-market-analyst, ARCH-mcp-moex-iss]
risk: medium
benefit: "Добавляет cost-aware планирование, feedback-loop, валидатор плана, YAML-DSL для сценариев и стресс-тесты портфеля как roadmap-функции."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Сделать подсистему планирования production-grade за счёт cost-aware планирования, feedback-loop по планам, LLM/self-check валидатора планов, описания целевого YAML-DSL для сценариев и подготовки сценария `portfolio_stress_test` поверх будущих advanced risk MCP-инструментов.

## Критерии приемки

- Реализовано cost-aware планирование:
  - `ToolRegistry` дополняется полем `cost_rank` (оценка стоимости) и, при необходимости, `reliability_rank`;
  - Planner оценивает примерную стоимость плана (количество шагов × cost_rank, грубая оценка токенов) и сравнивает её с лимитами `planner.limits` и режимами (`mode=fast/balanced/detailed`);
  - в `output.debug` и/или логах появляется оценка стоимости плана и использованный режим.
- Введён feedback-loop по планам:
  - логируются `scenario_type`, хэш плана, факты re-plan, типы ошибок и, при наличии, пользовательская/внутренняя оценка качества;
  - предусмотрен хотя бы один цикл анализа логов и обновления шаблонов/промптов на основе накопленных данных (описан процесс и зафиксирован в документации).
- Реализован `PlanValidator` (LLM-self-check или детерминированный модуль), который:
  - проверяет отсутствие циклов и нарушение лимитов (`MAX_PLAN_STEPS`, `MAX_TICKERS_PER_REQUEST`, бюджет токенов);
  - при некорректном плане инициирует re-plan, упрощает план или возвращает контролируемый отказ с понятным сообщением.
- В документации описан целевой YAML-формат сценариев (DSL) и приведены как минимум два примера YAML:
  - для `portfolio_risk`;
  - для ещё одного сценария (например, `compare_securities` или `index_risk_scan`);
  - уточнено, что на текущем этапе рабочий код использует Python-шаблоны, а YAML-файлы — это roadmap для будущего подключения без релиза кода.
- После появления advanced risk MCP-инструментов спроектирован и задокументирован ScenarioTemplate `portfolio_stress_test`, который:
  - использует baseline-портфель и стресс-сценарии (шоки по рынку/сектору);
  - сравнивает ключевые метрики до/после стресс-теста;
  - включён в roadmap-функциональность и связан с фазой 7 по advanced-риску.
- В разделе метрик успеха (документация/мониторинг) отражены показатели для планировщика: доля запросов с heuristic re-plan, среднее число LLM-вызовов, распределение по `scenario_type`, статистика по длине портфелей и доля случаев, когда включился `limit_portfolio`.

## Определение готовности

- В dev/стейдж окружении можно наблюдать и сравнивать стоимость и качество разных режимов планировщика (`fast/balanced/detailed`) и использовать эти данные для настройки.
- Валидатор плана перехватывает заведомо некорректные или слишком дорогие планы до их исполнения, а fallback-поведение (упрощение плана, re-plan, отказ) задокументировано и воспроизводимо.
- YAML-DSL и сценарий `portfolio_stress_test` оформлены как понятная дорожная карта для послевыходного развития системы, согласованная с задачами Фаз 6–7.

## Заметки

Фаза PE опирается на реализованные фазы P0/PB/PC, а также на будущие advanced risk MCP-инструменты; её результатом должен стать планировщик, готовый к эксплуатации в прод-среде и дальнейшему расширению без радикальных переработок.
