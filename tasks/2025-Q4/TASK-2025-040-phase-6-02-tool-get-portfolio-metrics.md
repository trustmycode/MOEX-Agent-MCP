---
id: TASK-2025-040
title: "Фаза 6.2. Tool get_portfolio_metrics (портфельный риск-анализ v1)"
status: backlog
priority: medium
type: feature
estimate: 32h
assignee: @unassigned
created: 2025-12-09
updated: 2025-12-09
parents: [TASK-2025-007]
arch_refs: [ARCH-mcp-moex-iss]
risk: medium
benefit: "Добавляет портфельный анализ v1: доходность, волатильность, концентрация и «красные флаги»."
audit_log:
  - {date: 2025-12-09, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Реализовать MCP-инструмент `get_portfolio_metrics`, который по набору бумаг с весами и периоду рассчитывает портфельную доходность, волатильность, концентрационные показатели и «красные флаги», с опциональной beta к индексу.

## Критерии приемки

- Вход включает:
  - массив `{ticker, weight_pct}` с проверкой, что сумма весов близка к 100%;
  - `from_date`, `to_date`;
  - (опционально) `benchmark_index_ticker`.
- Инструмент:
  - подтягивает временные ряды по тикерам (через `get_multi_ohlcv_timeseries` или напрямую через `IssClient`);
  - считает доходность портфеля за период и волатильность портфельных доходностей;
  - оценивает средний дневной объём;
  - формирует концентрационные метрики (top-N тикеров и секторов по весу);
  - заполняет `risk_flags[]` при превышении порогов по отдельным бумагам/сектору/волатильным бумагам с высоким весом.
- (Опционально) рассчитывается beta портфеля к индексу (`beta` и `beta_r2`) при наличии `benchmark_index_ticker`.

## Определение готовности

- Для тестового портфеля из 3–5 бумаг возвращается:
  - портфельная доходность и волатильность;
  - список top-N бумаг и секторов;
  - хотя бы один `risk_flag` при очевидной концентрации;
  - (если успели) beta и `beta_r2`.

## Заметки

Соответствует пункту 6.2 плана архитектора (Фаза 6).

