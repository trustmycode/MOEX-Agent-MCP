---
id: TASK-2025-064
title: "Фаза PC.3. Поведение portfolio_risk для больших портфелей"
status: backlog
priority: high
type: feature
estimate: 12h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-049]
arch_refs: [ARCH-agent-moex-market-analyst, ARCH-mcp-moex-iss]
risk: medium
benefit: "Обеспечивает контролируемое поведение сценария portfolio_risk при 50+ тикерах и честную деградацию анализа."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Расширить `PortfolioRiskScenarioTemplate`, добавив шаги парсинга портфеля из текста/таблицы/списка тикеров и `limit_portfolio`, который ограничивает число детально анализируемых бумаг до `MAX_TICKERS_PER_REQUEST` с честным отражением деградации в отчёте.

## Критерии приемки

- Реализован шаг парсинга портфеля (`parse_portfolio`), который:
  - поддерживает ввод в виде списка тикеров, пары `тикер вес` и табличного формата `Тикер;Доля`;
  - формирует внутреннюю структуру портфеля с тикерами и весами (при наличии) для 50+ бумаг.
- Реализован шаг `limit_portfolio`, который:
  - использует `MAX_TICKERS_PER_REQUEST` для определения максимального числа анализируемых бумаг;
  - при наличии весов выбирает top-N по весу, иначе — первые N тикеров из списка;
  - формирует множества `analyzed_tickers` и `tail_tickers`.
- План `portfolio_risk` использует `analyzed_tickers` для вызовов MCP и расчёта метрик, а хвост агрегируется в строку "прочие" в таблицах.
- В итоговом тексте отчёта обязательно присутствует явное пояснение деградации для больших портфелей (количество инструментов в портфеле, N детально рассмотренных позиций, агрегированный хвост).

## Определение готовности

- Интеграционные тесты с портфелем на 50+ бумаг демонстрируют стабильное поведение: ограничение до N тикеров, наличие строки "прочие" и корректные агрегированные метрики.
- Ограничения сценария `portfolio_risk` по числу детально анализируемых тикеров задокументированы в REQUIREMENTS/SPEC/ARCHITECTURE.

## Заметки

Поведение `portfolio_risk_drill_down` и интеграция с `ToolRegistry` для портфельных сценариев дорабатываются в соседних подзадачах.
