---
id: TASK-2025-058
title: "Фаза PA.3. Телеметрия планировщика и логирование сценариев"
status: backlog
priority: medium
type: feature
estimate: 8h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-047]
arch_refs: [ARCH-agent-moex-market-analyst]
risk: low
benefit: "Добавляет отдельные метрики и логи для стратегий планировщика и сценариев, включая portfolio_risk."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Добавить телеметрию и логирование для подсистемы планирования: метрики по построению и перепланированию планов, распределению сценариев и размерам портфелей, а также расширенное логирование для анализа поведения планировщика.

## Критерии приемки

- В модуле телеметрии агента заведены метрики вида:
  - `plans_built_total{strategy,scenario_type}`;
  - `plans_replanned_total{strategy}`;
  - `plans_failed_total{reason}`;
  - `portfolio_risk_tickers_total{bucket="<=10","11-30",">30"}`.
- В логах планировщика для каждого запроса фиксируются как минимум:
  - `scenario_type` (если определён);
  - количество тикеров в исходном запросе и в анализе;
  - факт применения ограничения по портфелю (`limited_to_top_n=true/false`).
- Метрики публикуются через уже существующий стек мониторинга (Prometheus/OTEL/Phoenix) и могут быть просмотрены на дашбордах.

## Определение готовности

- В dev-окружении по метрикам видно долю запросов с большими портфелями и частоту применения `limit_portfolio`.
- Логи и метрики планировщика используются как вход для задач фазы PE по feedback-loop и оптимизации сценариев.

## Заметки

Телеметрия планировщика дополняет, но не заменяет существующие метрики по MCP и LLM; она сосредоточена на качестве и структуре планов.
