---
id: TASK-2025-046
title: "Фаза P0. Basic-планировщик и лимиты"
status: backlog
priority: high
type: feature
estimate: 24h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-003]
children: [TASK-2025-052, TASK-2025-053, TASK-2025-054]
arch_refs: [ARCH-agent-moex-market-analyst]
risk: medium
benefit: "Фиксирует basic-режим планировщика с жёсткими лимитами и простым re-plan, включая поддержку сценария portfolio_risk."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Ввести basic-режим планировщика агента с конфигурируемыми лимитами на количество LLM-вызовов, шагов плана, глубину истории и размер портфеля, а также реализовать минимальный heuristic re-plan и гарантировать поддержку базовых сценариев (`single_security_overview`, `compare_securities`, `index_risk_scan`, `portfolio_risk`) в этом режиме для хакатона.

## Критерии приемки

- В конфигурации агента появляется режим `PLANNER_MODE`, по умолчанию установленный в значение `basic`; запуск агента в демо/прод окружении явно фиксирует этот режим.
- Реализован блок настроек `planner.limits` (конфиг/ENV), содержащий как минимум:
  - `MAX_LLM_CALLS_PER_REQUEST` (по умолчанию 3);
  - `MAX_PLAN_STEPS_BASIC` (по умолчанию 6) и `MAX_REPLAN_ATTEMPTS_BASIC` (по умолчанию 1);
  - `MAX_DAYS_PER_SECURITY` (например, 365) и `MAX_TICKERS_PER_REQUEST` (по умолчанию 10);
  - жёсткий бюджет токенов `HARD_TOKEN_BUDGET_PER_REQUEST` для одного запроса.
- Basic-планировщик читает значения `planner.limits` и фактически ограничивает длину плана, число LLM-вызовов и количество тикеров в портфельных сценариях (`portfolio_risk`) согласно этим лимитам.
- Реализован метод `BasicPlanningStrategy.replan(...)`, который для типовых ошибок:
  - `DATE_RANGE_TOO_LARGE` автоматически сужает период до `MAX_DAYS_PER_SECURITY`;
  - `TOO_MANY_TICKERS` ограничивает число бумаг до `MAX_TICKERS_PER_REQUEST` (с выбором top-N по весу при наличии весов или первых N тикеров из списка);
  - `RATE_LIMIT` уменьшает параллелизм/дробит запросы либо сообщает о контролируемой деградации;
  - количество попыток re-plan ограничено `MAX_REPLAN_ATTEMPTS_BASIC = 1`.
- Для сценариев `single_security_overview`, `compare_securities`, `index_risk_scan`, `portfolio_risk` задокументированы ожидаемые базовые планы (последовательности шагов) и реализованы smoke-тесты, проверяющие, что в режиме `PLANNER_MODE=basic` они стабильно отрабатывают без выхода за лимиты.
- В REQUIREMENTS/ARCHITECTURE добавлено явное описание лимитов basic-режима (количество LLM-вызовов, шагов, лимит тикеров в портфеле) и их назначения.

## Определение готовности

- При запуске агента в режиме `basic` для типичных пользовательских запросов ни один план не превышает заданные лимиты по шагам, LLM-вызовам и количеству анализируемых тикеров.
- Heuristic re-plan применяется не более одного раза на запрос, корректно обрабатывает типовые ошибки и фиксируется в debug-выводе (видно, что период или список тикеров был автоматически ограничен).
- Все четыре ключевых сценария работают в режиме `basic`, проходят smoke-тесты и демонстрируются в демо-конфигурации без ручных подстроек.

## Заметки

Фокус задачи — обеспечить предсказуемый и устойчивый basic-планировщик под хакатон, не меняя UX и сохраняя возможность дальнейшего расширения архитектуры планировщика (фазы PA–PE).
