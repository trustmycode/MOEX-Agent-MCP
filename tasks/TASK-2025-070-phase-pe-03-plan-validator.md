---
id: TASK-2025-070
title: "Фаза PE.3. PlanValidator и LLM-self-check"
status: backlog
priority: low
type: feature
estimate: 12h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-051]
arch_refs: [ARCH-agent-moex-market-analyst]
risk: medium
benefit: "Защищает систему от некорректных или слишком дорогих планов до их исполнения."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Реализовать `PlanValidator`, который проверяет планы на корректность (отсутствие циклов, соблюдение лимитов, согласованность шагов) и, при необходимости, инициирует re-plan, упрощение плана или контролируемый отказ.

## Критерии приемки

- Реализован модуль `PlanValidator`, который может работать:
  - в детерминированном режиме (статические проверки шагов и зависимостей);
  - и/или в LLM-self-check режиме (дополнительная проверка структуры плана через LLM) в зависимости от конфигурации.
- Проверки включают:
  - отсутствие циклических зависимостей между шагами;
  - соблюдение лимитов `MAX_PLAN_STEPS`, `MAX_TICKERS_PER_REQUEST` и бюджета токенов;
  - корректность типов шагов и ссылок на инструменты (`tool_name` присутствует в `ToolRegistry`).
- При обнаружении проблем `PlanValidator`:
  - либо запускает re-plan (если это возможно и не исчерпаны попытки);
  - либо упрощает план (например, убирает необязательные шаги);
  - либо возвращает контролируемый отказ с понятным сообщением пользователю.

## Определение готовности

- Тесты демонстрируют, что явно некорректные планы (циклы, превышение лимитов, отсутствующие инструменты) не попадают в исполнение и обрабатываются предсказуемым образом.

## Заметки

LLM-self-check может быть включён только в advanced-режиме и рассматривается как дополнительный уровень защиты.
