---
id: TASK-2025-111
title: "Микро-RAG в сценариях 5/7/9 (FR-KB-MVP-1)"
status: backlog
priority: medium
type: feature
estimate: 16h
assignee: @unassigned
created: 2025-12-11
updated: 2025-12-11
parents: [TASK-2025-005, TASK-2025-003]
children: []
arch_refs: [ARCH-agent-moex-market-analyst]
risk: medium
benefit: "Добавляет опциональные методические пояснения к метрикам риска в сценариях 5/7/9, не ломая базовый flow при отсутствии RAG."
audit_log:
  - {date: 2025-12-11, user: "@AI-Codex", action: "created with status backlog"}
---

## Описание

Интегрировать `kb-rag-mcp` через `KnowledgeSubagent` в существующие сценарии 5/7/9 (`issuer_peers_compare`, `portfolio_risk`, `cfo_liquidity_report`) и базовые сценарии (обзор тикера, сравнение, индекс), чтобы:

- после расчёта метрик риска (волатильность, max drawdown, концентрации, Var_light и т.п.) агент **опционально** запрашивал методические пояснения в RAG;
- `ExplainerSubagent` добавлял в `output.text` компактный блок «Как интерпретировать эти метрики» (1–3 абзаца) с опорой на корпоративные регламенты/методики;
- при недоступности `kb-rag-mcp` сценарии продолжали работать, просто без RAG-блока (в соответствии с FR-KB-MVP-1).

## Критерии приемки

- В агенте реализован `KnowledgeSubagent` (или эквивалентный компонент), который:
  - формирует запросы к `kb-rag-mcp` с учётом сценария (`scenario_type`), роли пользователя (CFO/риск-менеджер) и языка;
  - получает список snippets `{id, title, snippet, source_type, url, date, tickers[], event_type}` и передаёт их в ExplainerSubagent.
- Для сценариев:
  - `single_security_overview`,
  - `compare_securities`,
  - `index_risk_scan`,
  - `portfolio_risk_basic` (и, при наличии, `portfolio_correlation_view`),
  реализовано опциональное обращение к RAG (feature-flag / конфигурация), добавляющее методический блок к текстовому отчёту.
- Поведение при отсутствии RAG:
  - ошибки `kb-rag-mcp` не приводят к падению всего ответа агента;
  - ExplainerSubagent корректно строит текст без RAG, а в debug можно увидеть причину отсутствия пояснений (например, `rag_unavailable=true`).
- В `output.debug` присутствует поле `rag_sources`, содержащее идентификаторы/метаданные использованных RAG-документов.
- Документация (REQUIREMENTS, ARCHITECTURE) обновлена/синхронизирована, ссылки на FR-KB-MVP-1 соответствуют фактической реализации.

## Определение готовности

- Для тестового набора запросов по сценариям 5/7/9:
  - при включённом RAG отчёты содержат методический блок с корректными ссылками на источники;
  - при выключенном RAG или его недоступности отчёты не ломаются и содержат только числовые и текстовые выводы без RAG-блока.
- Команда считает поведение RAG-усиления предсказуемым и безопасным с точки зрения UX и рисков «галлюцинаций» по числам.

