---
id: TASK-2025-126
title: "Интеграция динамического планирования в Orchestrator"
status: todo
priority: medium
type: feature
estimate: 8h
assignee: @unassigned
created: 2025-12-13
updated: 2025-12-13
parents: [TASK-2025-122, TASK-2025-125]
children: []
arch_refs: [ARCH-agent-moex-market-analyst]
risk: high
benefit: "Обеспечивает гибкость системы: если запрос не подходит под жесткие шаблоны, система сама строит маршрут исполнения."
audit_log:
  - {date: 2025-12-13, user: "@AI-Architect", action: "created"}
---

## Описание

Модифицировать `OrchestratorAgent`, чтобы он мог использовать `ResearchPlannerSubagent` для построения пайплайна выполнения, когда статический `IntentClassifier` не может определить сценарий или когда явно требуется сложное исследование.

## Объем работ

1. **Доработка `OrchestratorAgent.handle_request`**:
   - Логика ветвления:
     - ЕСЛИ `IntentClassifier` вернул известный сценарий (например, `PORTFOLIO_RISK`) -> использовать статический `get_pipeline` (как сейчас).
     - ЕСЛИ `IntentClassifier` вернул `UNKNOWN` ИЛИ уверенность (confidence) низкая -> вызвать `ResearchPlannerSubagent`.
2. **Адаптация плана**:
   - Преобразование вывода `ResearchPlannerSubagent` (список шагов) в объект `ScenarioPipeline`, который умеет исполнять оркестратор.
3. **Обработка ошибок планирования**:
   - Если планировщик не смог создать валидный план (или LLM вернула мусор) -> fallback на `UNKNOWN_PIPELINE` (просто ответ "Я не понял запрос").

## Критерии приемки

- [ ] В `OrchestratorAgent` добавлена логика вызова `research_planner`.
- [ ] При запросе "Проанализируй влияние ключевой ставки на акции застройщиков" (нестандартный запрос):
  1. Классификатор возвращает `UNKNOWN`.
  2. Оркестратор вызывает `ResearchPlannerSubagent`.
  3. Планировщик возвращает шаги: `market_data` (получить котировки PIKK/SMLT) -> `knowledge` (найти новости про ставку) -> `explainer`.
  4. Оркестратор успешно выполняет эти шаги.
- [ ] Сохранена работоспособность старых статических сценариев (регрессионный тест).
- [ ] В `output.debug` добавляется информация о том, был ли план статическим или динамическим.

## Заметки

- Важно следить за тем, чтобы динамический план не создавал циклов или слишком длинных цепочек (ограничить макс. 5 шагов).
