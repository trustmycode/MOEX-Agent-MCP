# TASK-2025-101: Реализация ребалансировки в risk-analytics-mcp (`suggest_rebalance`)

## Статус

- Статус: planned
- Приоритет: P0
- Компонент: risk-analytics-mcp
- Связанные сценарии: portfolio_risk (7), cfo_liquidity_report (9)

## Контекст

По решению архитектуры вся математика ребалансировки и бизнес-правила должны находиться в MCP (`risk-analytics-mcp`), а агент выполняет только оркестрацию, сбор ограничений и объяснение результата пользователю.

## Цель

Реализовать tool `suggest_rebalance` в `risk-analytics-mcp`, который принимает текущий портфель и ограничения по риску/обороту и возвращает детерминированный JSON с предложенной ребалансировкой.

## Объём работ

### In scope

- Pydantic-модели входа/выхода для `suggest_rebalance`:
  - вход: текущие позиции, таргет-профиль риска (макс. доля акций/облигаций/FX, лимиты концентрации, max turnover и т.п.),
  - выход: целевые веса по инструментам, список сделок (buy/sell, количество, оценка оборота).
- Имплементация простой эвристики ребалансировки:
  - приведение портфеля к таргет-аллокации по классам активов,
  - соблюдение лимитов концентрации по эмитентам/инструментам,
  - контроль max turnover (ограничение суммарного оборота).
- Обработка ошибок и валидация:
  - некорректные тикеры,
  - пустой портфель,
  - невозможность достичь таргет-профиля при заданных ограничениях.
- Юнит-тесты на фиксированных JSON-примерах портфелей.
- Пример вызова `suggest_rebalance` и пример ответа в документации MCP (README/спека tools).

### Out of scope

- Оптимизационные алгоритмы (QP/MILP).
- Учёт комиссий и налогов.
- Интеграция с реальными брокерскими аккаунтами.

## Acceptance Criteria

- [ ] В коде `risk-analytics-mcp` есть tool `suggest_rebalance` с Pydantic-схемами для входа и выхода.
- [ ] Логика ребалансировки использует только входные данные и не зависит от состояния агента.
- [ ] Реализовано минимум 3 unit-теста с фиксированными портфелями, которые полностью проходят.
- [ ] В случае невыполнимых ограничений MCP возвращает структурированную ошибку с человекочитаемым описанием (для последующей интерпретации агентом).
- [ ] В README/спеке MCP добавлен раздел с примером JSON-запроса/ответа для `suggest_rebalance`.

