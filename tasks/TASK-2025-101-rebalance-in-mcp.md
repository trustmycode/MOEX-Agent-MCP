# TASK-2025-101: Реализация ребалансировки в risk-analytics-mcp (`suggest_rebalance`)

## Статус

- Статус: ✅ **DONE**
- Дата завершения: 2025-12-11
- Приоритет: P0
- Компонент: risk-analytics-mcp
- Связанные сценарии: portfolio_risk (7), cfo_liquidity_report (9)

## Контекст

По решению архитектуры вся математика ребалансировки и бизнес-правила должны находиться в MCP (`risk-analytics-mcp`), а агент выполняет только оркестрацию, сбор ограничений и объяснение результата пользователю.

## Цель

Реализовать tool `suggest_rebalance` в `risk-analytics-mcp`, который принимает текущий портфель и ограничения по риску/обороту и возвращает детерминированный JSON с предложенной ребалансировкой.

## Объём работ

### In scope

- Pydantic-модели входа/выхода для `suggest_rebalance`:
  - вход: текущие позиции, таргет-профиль риска (макс. доля акций/облигаций/FX, лимиты концентрации, max turnover и т.п.),
  - выход: целевые веса по инструментам, список сделок (buy/sell, количество, оценка оборота).
- Имплементация простой эвристики ребалансировки:
  - приведение портфеля к таргет-аллокации по классам активов,
  - соблюдение лимитов концентрации по эмитентам/инструментам,
  - контроль max turnover (ограничение суммарного оборота).
- Обработка ошибок и валидация:
  - некорректные тикеры,
  - пустой портфель,
  - невозможность достичь таргет-профиля при заданных ограничениях.
- Юнит-тесты на фиксированных JSON-примерах портфелей.
- Пример вызова `suggest_rebalance` и пример ответа в документации MCP (README/спека tools).

### Out of scope

- Оптимизационные алгоритмы (QP/MILP).
- Учёт комиссий и налогов.
- Интеграция с реальными брокерскими аккаунтами.

## Acceptance Criteria

- [x] В коде `risk-analytics-mcp` есть tool `suggest_rebalance` с Pydantic-схемами для входа и выхода.
- [x] Логика ребалансировки использует только входные данные и не зависит от состояния агента.
- [x] Реализовано минимум 3 unit-теста с фиксированными портфелями, которые полностью проходят.
- [x] В случае невыполнимых ограничений MCP возвращает структурированную ошибку с человекочитаемым описанием (для последующей интерпретации агентом).
- [x] В README/спеке MCP добавлен раздел с примером JSON-запроса/ответа для `suggest_rebalance`.
- [x] E2E тесты через curl прошли успешно (10 сценариев).

## Результаты тестирования

### Unit-тесты
- `tests/test_suggest_rebalance.py` — 17 тестов ✅
- `tests/test_suggest_rebalance_e2e.py` — 15 тестов ✅

### E2E сценарии (curl)
| # | Сценарий | Статус |
|---|----------|--------|
| 1 | Снижение концентрации SBER 45%→25% | ✅ |
| 2 | Концентрация по эмитенту Сбербанк | ✅ |
| 3 | Целевая аллокация 60/40 | ✅ |
| 4 | Консервативная (оборот 5%) | ✅ |
| 5 | CFO квартальная (50M ₽) | ✅ |
| 6 | Пенсионный фонд (100M ₽) | ✅ |
| 7 | Небольшой портфель (10K ₽) | ✅ |
| 100 | Пустой портфель | ✅ ошибка |
| 101 | Веса ≠ 1.0 | ✅ ошибка |
| 102 | Одна позиция | ✅ warnings |

### Файлы
- `risk_analytics_mcp/calculations/rebalance.py` — логика ребалансировки
- `risk_analytics_mcp/tools/suggest_rebalance.py` — MCP tool
- `risk_analytics_mcp/models/__init__.py` — Pydantic-модели
- `docs/schemas/suggest_rebalance_input.json` — JSON Schema входа
- `docs/schemas/suggest_rebalance_output.json` — JSON Schema выхода
- `docs/SPEC_risk-analytics-mcp.md` — спецификация
- `tests/e2e_suggest_rebalance_curl.md` — E2E сценарии curl
- `tests/e2e_suggest_rebalance.sh` — автоматический скрипт

