---
id: TASK-2025-068
title: "Фаза PE.1. Cost-aware планирование"
status: backlog
priority: low
type: feature
estimate: 10h
assignee: @unassigned
created: 2025-12-10
updated: 2025-12-10
parents: [TASK-2025-051]
arch_refs: [ARCH-agent-moex-market-analyst, ARCH-mcp-moex-iss]
risk: medium
benefit: "Позволяет оценивать и ограничивать стоимость планов по шагам и токенам в разных режимах."
audit_log:
  - {date: 2025-12-10, user: "@AI-DocArchitect", action: "created with status backlog"}
---

## Описание

Добавить в планировщик оценку стоимости плана (по числу шагов, стоимости инструментов и приблизительным токенам) и режимы `fast/balanced/detailed`, использующие разные лимиты `planner.limits` и влияющие на глубину анализа.

## Критерии приемки

- `ToolSpec` дополнен полем `cost_rank` (и при необходимости `reliability_rank`), задающим относительную стоимость вызова инструмента.
- Planner перед выполнением плана оценивает его стоимость:
  - число шагов × `cost_rank` инструментов;
  - приблизительное количество токенов для LLM (на основе эвристик или конфигурации).
- Реализованы режимы планирования:
  - `mode=fast` — строгие лимиты по числу шагов и токенов (например, 4 шага, 4000 токенов);
  - `mode=balanced` — лимиты по умолчанию;
  - `mode=detailed` — более щадящие лимиты для сложных сценариев (например, `portfolio_risk_drill_down`).
- Информация о выбранном режиме и оценке стоимости плана выводится в `output.debug` и/или логи.

## Определение готовности

- В dev-окружении можно сравнить разные режимы по средней стоимости и времени ответа для одинаковых сценариев.
- При превышении жёстких лимитов план либо упрощается, либо отклоняется с понятным сообщением пользователю.

## Заметки

Cost-aware планирование должно работать поверх реализованных лимитов `planner.limits` и телеметрии планировщика.
