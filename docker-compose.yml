services:
  moex-iss-mcp:
    image: moex-iss-mcp:local
    platform: linux/amd64
    build:
      context: .
      dockerfile: moex_iss_mcp/Dockerfile
      cache_from:
        - type=local,src=.docker-cache/moex-iss-mcp
      cache_to:
        - type=local,dest=.docker-cache/moex-iss-mcp,mode=max
    env_file:
      - .env
    environment:
      - PORT=${PORT:-8000}
      - HOST=0.0.0.0
    ports:
      - "${PORT:-8000}:8000"

  risk-analytics-mcp:
    image: risk-analytics-mcp:local
    platform: linux/amd64
    build:
      context: .
      dockerfile: risk_analytics_mcp/Dockerfile
      cache_from:
        - type=local,src=.docker-cache/risk-analytics-mcp
      cache_to:
        - type=local,dest=.docker-cache/risk-analytics-mcp,mode=max
    env_file:
      - .env
    environment:
      - RISK_MCP_PORT=${RISK_MCP_PORT:-8010}
      - HOST=0.0.0.0
    ports:
      - "${RISK_MCP_PORT:-8010}:8010"
    depends_on:
      moex-iss-mcp:
        condition: service_healthy

  agent:
    image: moex-market-analyst-agent:local
    platform: linux/amd64
    build:
      context: .
      dockerfile: packages/agent-service/Dockerfile
      cache_from:
        - type=local,src=.docker-cache/agent
      cache_to:
        - type=local,dest=.docker-cache/agent,mode=max
    env_file:
      - .env
    environment:
      - AGENT_PORT=${AGENT_PORT:-8100}
      - MOEX_ISS_MCP_URL=${MOEX_ISS_MCP_URL:-http://moex-iss-mcp:8000}
      - RISK_ANALYTICS_MCP_URL=${RISK_ANALYTICS_MCP_URL:-http://risk-analytics-mcp:8010}
      - ENVIRONMENT=${ENVIRONMENT:-dev}
      - AGENT_ENABLE_DEBUG=${AGENT_ENABLE_DEBUG:-true}
    ports:
      - "${AGENT_PORT:-8100}:8100"
    depends_on:
      moex-iss-mcp:
        condition: service_healthy
      risk-analytics-mcp:
        condition: service_healthy

  web:
    image: moex-web:local
    platform: linux/amd64
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        NEXT_DISABLE_SOURCEMAPS: ${NEXT_DISABLE_SOURCEMAPS:-1}
      cache_from:
        - type=local,src=.docker-cache/web
      cache_to:
        - type=local,dest=.docker-cache/web,mode=max
    env_file:
      - .env
    environment:
      - PORT=${WEB_PORT:-3000}
      - HOSTNAME=0.0.0.0
      - AGENT_SERVICE_URL=${AGENT_SERVICE_URL:-http://agent:8100/agui}
      - NODE_ENV=production
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      agent:
        condition: service_healthy
